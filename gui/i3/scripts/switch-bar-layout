#!/usr/bin/env bash

# i3blocks Layout Switcher
# Switch between different minimalistic bar layouts

LAYOUTS_DIR="$HOME/.config/i3"
CURRENT_CONFIG="$LAYOUTS_DIR/i3blocks.conf"

show_help() {
    echo "i3blocks Layout Switcher"
    echo ""
    echo "Usage: $0 [LAYOUT]"
    echo ""
    echo "Available layouts:"
    echo "  default     - Full featured bar with progress bars and icons"
    echo "  minimal     - Ultra-minimal with only essential info"
    echo "  icons       - Icon-only layout with minimal text"
    echo "  dots        - Clean design with dot separators"
    echo "  numbers     - Pure minimalism, just numbers"
    echo "  flow        - Single flow without separators"
    echo ""
    echo "  list        - Show current layout"
    echo "  help        - Show this help"
}

get_current_layout() {
    if [[ -L "$CURRENT_CONFIG" ]]; then
        local target=$(readlink "$CURRENT_CONFIG")
        local layout=$(basename "$target" | sed 's/i3blocks-\(.*\)\.conf/\1/' | sed 's/i3blocks\.conf/default/')
        echo "$layout"
    else
        echo "unknown"
    fi
}

switch_layout() {
    local layout="$1"
    local config_file=""
    
    case "$layout" in
        "default")
            config_file="$LAYOUTS_DIR/i3blocks.conf.orig"
            if [[ ! -f "$config_file" ]]; then
                echo "❌ Default layout backup not found"
                return 1
            fi
            ;;
        "minimal")
            config_file="$LAYOUTS_DIR/i3blocks-minimal.conf"
            ;;
        "icons")
            config_file="$LAYOUTS_DIR/i3blocks-icon-only.conf"
            ;;
        "dots")
            config_file="$LAYOUTS_DIR/i3blocks-dots.conf"
            ;;
        "numbers")
            config_file="$LAYOUTS_DIR/i3blocks-numbers.conf"
            ;;
        "flow")
            config_file="$LAYOUTS_DIR/i3blocks-flow.conf"
            ;;
        *)
            echo "❌ Unknown layout: $layout"
            show_help
            return 1
            ;;
    esac
    
    if [[ ! -f "$config_file" ]]; then
        echo "❌ Layout file not found: $config_file"
        return 1
    fi
    
    # Backup current config if it's not a symlink
    if [[ ! -L "$CURRENT_CONFIG" && -f "$CURRENT_CONFIG" ]]; then
        cp "$CURRENT_CONFIG" "$CURRENT_CONFIG.backup"
        echo "📁 Current config backed up to i3blocks.conf.backup"
    fi
    
    # Create symlink to new layout
    ln -sf "$config_file" "$CURRENT_CONFIG"
    
    # Restart i3blocks
    pkill -f i3blocks
    sleep 0.5
    i3-msg restart > /dev/null 2>&1
    
    echo "✅ Switched to '$layout' layout"
    echo "🔄 i3 restarted to apply changes"
}

# Main script logic
case "${1:-help}" in
    "list")
        current=$(get_current_layout)
        echo "Current layout: $current"
        ;;
    "help"|"-h"|"--help")
        show_help
        ;;
    *)
        switch_layout "$1"
        ;;
esac