#!/usr/bin/env bash
# Minimal caffeine toggle for i3blocks
# Single icon that changes color when active

# Check if caffeine is running
CAFFEINE_PID=$(pgrep -x caffeine)

# Handle mouse clicks
case $BLOCK_BUTTON in
    1) # Left click - toggle
        if [ -z "$CAFFEINE_PID" ]; then
            caffeine &
            # Also disable DPMS to be sure
            xset -dpms
            xset s off
        else
            pkill -x caffeine
            # Re-enable DPMS with our configured timeouts
            xset +dpms
            xset s 1200
            xset dpms 1800 1800 1800
        fi
        ;;
    3) # Right click - show time remaining
        if [ -z "$CAFFEINE_PID" ]; then
            IDLE_TIME=$(xset q | grep "Standby:" | awk '{print $2}')
            notify-send "Screen Lock" "Active (${IDLE_TIME}s timeout)" -t 2000
        else
            notify-send "Screen Lock" "Disabled (Caffeine ON)" -t 2000
        fi
        ;;
esac

# Refresh PID after potential toggle
CAFFEINE_PID=$(pgrep -x caffeine)

# Output: single icon that changes appearance
if [ -z "$CAFFEINE_PID" ]; then
    # Inactive - empty circle or moon
    echo "○"        # Empty circle (discrete)
    echo "○"
    echo "#666666"  # Dark gray
else
    # Active - filled circle or sun
    echo "●"        # Filled circle (active)  
    echo "●"
    echo "#FFEB3B"  # Bright yellow
fi